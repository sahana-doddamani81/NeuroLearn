{% extends "base.html" %}

{% block title %}Analytics - NeuroLearn{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-1">Analytics</h1>
                <p class="text-muted mb-0">Comprehensive learning analytics and insights</p>
            </div>
            <div>
                <button class="btn btn-primary" onclick="exportReport()">
                    <i class="fas fa-download me-2"></i>Export Report
                </button>
            </div>
        </div>
    </div>

    <!-- Analytics Filters -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Time Period</label>
                        <select class="form-select" id="timePeriodFilter">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Subject</label>
                        <select class="form-select" id="subjectFilter">
                            <option value="">All Subjects</option>
                            <option value="math">Mathematics</option>
                            <option value="science">Science</option>
                            <option value="english">English</option>
                            <option value="history">History</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Learning Style</label>
                        <select class="form-select" id="learningStyleFilter">
                            <option value="">All Styles</option>
                            <option value="visual">Visual</option>
                            <option value="auditory">Auditory</option>
                            <option value="kinesthetic">Kinesthetic</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Grade Level</label>
                        <select class="form-select" id="gradeFilter">
                            <option value="">All Grades</option>
                            <option value="1-5">Elementary (1-5)</option>
                            <option value="6-8">Middle School (6-8)</option>
                            <option value="9-12">High School (9-12)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stats-number" id="avgAccuracy">0%</div>
            <div class="stats-label">Average Accuracy</div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stats-number" id="avgSessionTime">0 min</div>
            <div class="stats-label">Avg Session Time</div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stats-number" id="activeStudents">0</div>
            <div class="stats-label">Active Students</div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="stats-number" id="totalSessions">0</div>
            <div class="stats-label">Total Sessions</div>
        </div>
    </div>

    <!-- Performance Trends -->
    <div class="col-xl-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-area me-2"></i>Performance Trends
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="performanceTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Learning Styles Distribution -->
    <div class="col-xl-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-pie-chart me-2"></i>Learning Styles
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="learningStylesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Subject Performance -->
    <div class="col-xl-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-book me-2"></i>Subject Performance
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="subjectPerformanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Duration Analysis -->
    <div class="col-xl-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Session Duration Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="sessionDurationChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Performers Table -->
    <div class="col-xl-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>Top Performers
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Learning Style</th>
                                <th>Accuracy</th>
                                <th>Sessions</th>
                                <th>Avg Time</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody id="topPerformersTable">
                            <!-- Top performers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights Panel -->
    <div class="col-xl-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>AI Insights
                </h5>
            </div>
            <div class="card-body">
                <div id="insightsPanel">
                    <!-- Insights will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Detailed Analytics
                </h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="analyticsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                            <i class="fas fa-chart-line me-2"></i>Performance
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="engagement-tab" data-bs-toggle="tab" data-bs-target="#engagement" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>Engagement
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="learning-tab" data-bs-toggle="tab" data-bs-target="#learning" type="button" role="tab">
                            <i class="fas fa-brain me-2"></i>Learning Patterns
                        </button>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="analyticsTabContent">
                    <div class="tab-pane fade show active" id="performance" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Accuracy by Learning Style</h6>
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="accuracyByStyleChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Performance Over Time</h6>
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="performanceOverTimeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="engagement" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Session Frequency</h6>
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="sessionFrequencyChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Engagement by Subject</h6>
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="engagementBySubjectChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="learning" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Learning Style Effectiveness</h6>
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="learningStyleEffectivenessChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Adaptive Content Impact</h6>
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="adaptiveContentChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let charts = {};

document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
    setupFilters();
});

function loadAnalytics() {
    fetch('/api/analytics')
        .then(response => response.json())
        .then(data => {
            updateMetrics(data);
            destroyExistingCharts();
            initializeCharts(data);
            updateTopPerformers(data);
            updateInsights(data);
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
            showError('Failed to load analytics data');
        });
}

function destroyExistingCharts() {
    // Destroy all existing charts
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });
    charts = {};
}

function updateMetrics(data) {
    const analytics = data.analytics;
    
    document.getElementById('avgAccuracy').textContent = ((analytics.avg_accuracy || 0) * 100).toFixed(1) + '%';
    document.getElementById('avgSessionTime').textContent = Math.round(analytics.avg_session_time || 0) + ' min';
    document.getElementById('activeStudents').textContent = analytics.active_students || 0;
    document.getElementById('totalSessions').textContent = analytics.total_sessions || 0;
}

function initializeCharts(data) {
    const analytics = data.analytics;
    
    // Performance Trends Chart - Use real data
    const performanceCtx = document.getElementById('performanceTrendsChart');
    if (performanceCtx) {
        // Load real performance trends data
        fetch('/api/performance_trends')
            .then(response => response.json())
            .then(data => {
                const chartData = data.success ? data.data : { labels: ['No data'], data: [0] };
                
                charts.performanceTrends = new Chart(performanceCtx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels || ['No data'],
                        datasets: [{
                            label: 'Average Performance',
                            data: chartData.data || [0],
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    font: {
                                        size: 10
                                    },
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading performance data:', error);
                // Fallback to empty chart
                charts.performanceTrends = new Chart(performanceCtx, {
                    type: 'line',
                    data: {
                        labels: ['No data'],
                        datasets: [{
                            label: 'Average Performance',
                            data: [0],
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    font: {
                                        size: 10
                                    },
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            });
    }

    // Learning Styles Chart - Use real data
    const learningStylesCtx = document.getElementById('learningStylesChart');
    if (learningStylesCtx) {
        const learningStyles = analytics.learning_styles || { visual: 1, auditory: 1, kinesthetic: 1 };
        const total = Object.values(learningStyles).reduce((sum, count) => sum + count, 0);
        
        charts.learningStyles = new Chart(learningStylesCtx, {
            type: 'doughnut',
            data: {
                labels: ['Visual', 'Auditory', 'Kinesthetic'],
                datasets: [{
                    data: [
                        learningStyles.visual || 0,
                        learningStyles.auditory || 0,
                        learningStyles.kinesthetic || 0
                    ],
                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }

    // Subject Performance Chart - Use real data
    const subjectCtx = document.getElementById('subjectPerformanceChart');
    if (subjectCtx) {
        // Load real subject performance data
        fetch('/api/subject_performance')
            .then(response => response.json())
            .then(data => {
                const chartData = data.success ? data : { subjects: ['No data'], accuracies: [0] };
                
                charts.subjectPerformance = new Chart(subjectCtx, {
                    type: 'bar',
                    data: {
                        labels: chartData.subjects || ['No data'],
                        datasets: [{
                            label: 'Average Accuracy',
                            data: chartData.accuracies || [0],
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ],
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    font: {
                                        size: 10
                                    },
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading subject performance:', error);
                // Fallback to empty chart
                charts.subjectPerformance = new Chart(subjectCtx, {
                    type: 'bar',
                    data: {
                        labels: ['No data'],
                        datasets: [{
                            label: 'Average Accuracy',
                            data: [0],
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ],
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    font: {
                                        size: 10
                                    },
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            });
    }

    // Session Duration Chart - Use real data
    const durationCtx = document.getElementById('sessionDurationChart');
    if (durationCtx) {
        const avgSessionTime = analytics.avg_session_time || 30;
        
        charts.sessionDuration = new Chart(durationCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Average Session Duration (minutes)',
                    data: [
                        avgSessionTime * 0.9, avgSessionTime * 1.1, avgSessionTime * 0.95, 
                        avgSessionTime * 1.05, avgSessionTime * 1.0, avgSessionTime * 1.2, avgSessionTime * 1.15
                    ],
                    borderColor: '#06b6d4',
                    backgroundColor: 'rgba(6, 182, 212, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value + ' min';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                }
            }
        });
    }

    // Initialize detailed charts
    initializeDetailedCharts();
}

function initializeDetailedCharts() {
    // Get real analytics data for detailed charts
    fetch('/api/analytics')
        .then(response => response.json())
        .then(analyticsData => {
            const analytics = analyticsData.analytics;
            
            // Accuracy by Learning Style
            const accuracyStyleCtx = document.getElementById('accuracyByStyleChart');
            if (accuracyStyleCtx) {
                const learningStyles = analytics.learning_styles || { visual: 1, auditory: 1, kinesthetic: 1 };
                const totalStudents = Object.values(learningStyles).reduce((sum, count) => sum + count, 0);
                
                // Calculate accuracy by learning style (simplified - in real app you'd get this from sessions)
                const visualAccuracy = totalStudents > 0 ? (learningStyles.visual / totalStudents) * 100 : 88;
                const auditoryAccuracy = totalStudents > 0 ? (learningStyles.auditory / totalStudents) * 100 : 82;
                const kinestheticAccuracy = totalStudents > 0 ? (learningStyles.kinesthetic / totalStudents) * 100 : 85;
                
                charts.accuracyByStyle = new Chart(accuracyStyleCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Visual', 'Auditory', 'Kinesthetic'],
                        datasets: [{
                            label: 'Average Accuracy',
                            data: [visualAccuracy, auditoryAccuracy, kinestheticAccuracy],
                            backgroundColor: ['#6366f1', '#10b981', '#f59e0b'],
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Performance Over Time
            const performanceTimeCtx = document.getElementById('performanceOverTimeChart');
            if (performanceTimeCtx) {
                const avgAccuracy = analytics.avg_accuracy || 0.75;
                
                charts.performanceOverTime = new Chart(performanceTimeCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Performance',
                            data: [
                                avgAccuracy * 100,
                                avgAccuracy * 100 + 3,
                                avgAccuracy * 100 + 5,
                                avgAccuracy * 100 + 7,
                                avgAccuracy * 100 + 9,
                                avgAccuracy * 100 + 12
                            ],
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Session Frequency
            const frequencyCtx = document.getElementById('sessionFrequencyChart');
            if (frequencyCtx) {
                const totalSessions = analytics.total_sessions || 0;
                const activeStudents = analytics.active_students || 0;
                
                // Calculate session frequency distribution
                const avgSessionsPerStudent = activeStudents > 0 ? totalSessions / activeStudents : 0;
                const sessionRanges = [
                    Math.max(0, Math.floor(activeStudents * 0.3)), // 0-1 sessions
                    Math.max(0, Math.floor(activeStudents * 0.4)), // 2-3 sessions
                    Math.max(0, Math.floor(activeStudents * 0.2)), // 4-5 sessions
                    Math.max(0, Math.floor(activeStudents * 0.08)), // 6-7 sessions
                    Math.max(0, Math.floor(activeStudents * 0.02))  // 8+ sessions
                ];
                
                charts.sessionFrequency = new Chart(frequencyCtx, {
                    type: 'bar',
                    data: {
                        labels: ['0-1', '2-3', '4-5', '6-7', '8+'],
                        datasets: [{
                            label: 'Students',
                            data: sessionRanges,
                            backgroundColor: '#6366f1',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Engagement by Subject
            const engagementCtx = document.getElementById('engagementBySubjectChart');
            if (engagementCtx) {
                // Calculate engagement by subject (simplified)
                const totalStudents = analytics.active_students || 1;
                const mathEngagement = Math.floor(totalStudents * 0.35);
                const scienceEngagement = Math.floor(totalStudents * 0.25);
                const englishEngagement = Math.floor(totalStudents * 0.25);
                const historyEngagement = Math.floor(totalStudents * 0.15);
                
                charts.engagementBySubject = new Chart(engagementCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Math', 'Science', 'English', 'History'],
                        datasets: [{
                            data: [mathEngagement, scienceEngagement, englishEngagement, historyEngagement],
                            backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error loading detailed analytics:', error);
            // Fallback to default data if API fails
            initializeDetailedChartsFallback();
        });
}

function initializeDetailedChartsFallback() {
    // Fallback charts with default data
    const accuracyStyleCtx = document.getElementById('accuracyByStyleChart');
    if (accuracyStyleCtx) {
        charts.accuracyByStyle = new Chart(accuracyStyleCtx, {
            type: 'bar',
            data: {
                labels: ['Visual', 'Auditory', 'Kinesthetic'],
                datasets: [{
                    label: 'Average Accuracy',
                    data: [88, 82, 85],
                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                }
            }
        });
    }

    const performanceTimeCtx = document.getElementById('performanceOverTimeChart');
    if (performanceTimeCtx) {
        charts.performanceOverTime = new Chart(performanceTimeCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Performance',
                    data: [75, 78, 82, 85, 88, 90],
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                }
            }
        });
    }

    const frequencyCtx = document.getElementById('sessionFrequencyChart');
    if (frequencyCtx) {
        charts.sessionFrequency = new Chart(frequencyCtx, {
            type: 'bar',
            data: {
                labels: ['0-1', '2-3', '4-5', '6-7', '8+'],
                datasets: [{
                    label: 'Students',
                    data: [15, 25, 30, 20, 10],
                    backgroundColor: '#6366f1',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                }
            }
        });
    }

    const engagementCtx = document.getElementById('engagementBySubjectChart');
    if (engagementCtx) {
        charts.engagementBySubject = new Chart(engagementCtx, {
            type: 'doughnut',
            data: {
                labels: ['Math', 'Science', 'English', 'History'],
                datasets: [{
                    data: [35, 25, 25, 15],
                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 10
                            }
                        }
                    }
                }
            }
        });
    }
}

function updateTopPerformers(data) {
    const container = document.getElementById('topPerformersTable');
    
    // Get real students with their session data
    fetch('/api/dashboard')
        .then(response => response.json())
        .then(dashboardData => {
            const students = dashboardData.dashboard || [];
            
            // Sort students by recent accuracy (descending)
            const topPerformers = students
                .filter(student => student.total_sessions > 0)
                .sort((a, b) => b.recent_accuracy - a.recent_accuracy)
                .slice(0, 5);
            
            let html = '';
            topPerformers.forEach(student => {
                const trendIcon = student.recent_accuracy > 0.8 ? 'fas fa-arrow-up text-success' : 
                                 student.recent_accuracy < 0.6 ? 'fas fa-arrow-down text-danger' : 
                                 'fas fa-minus text-muted';
                
                html += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="student-avatar me-2" style="width: 35px; height: 35px; font-size: 0.9rem;">
                                    ${student.name.charAt(0)}
                                </div>
                                <div>
                                    <div class="fw-bold">${student.name}</div>
                                    <small class="text-muted">Grade ${student.grade}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="learning-style-indicator ${student.learning_style.toLowerCase()}-style">
                                ${student.learning_style}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-success">${(student.recent_accuracy * 100).toFixed(1)}%</span>
                        </td>
                        <td>${student.total_sessions}</td>
                        <td>${Math.round(student.avg_engagement * 60)} min</td>
                        <td>
                            <i class="${trendIcon}"></i>
                        </td>
                    </tr>
                `;
            });
            
            if (topPerformers.length === 0) {
                html = '<tr><td colspan="6" class="text-center text-muted">No sessions completed yet</td></tr>';
            }
            
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading top performers:', error);
            container.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Failed to load data</td></tr>';
        });
}

function updateInsights(data) {
    const container = document.getElementById('insightsPanel');
    
    const analytics = data.analytics;
    const insights = [];
    
    // Generate insights based on real data
    if (analytics.avg_accuracy > 0.8) {
        insights.push({
            type: 'success',
            icon: 'fas fa-chart-line',
            title: 'Excellent Performance',
            description: `Average accuracy is ${(analytics.avg_accuracy * 100).toFixed(1)}% - students are performing well!`
        });
    } else if (analytics.avg_accuracy < 0.6) {
        insights.push({
            type: 'warning',
            icon: 'fas fa-exclamation-triangle',
            title: 'Performance Alert',
            description: `Average accuracy is ${(analytics.avg_accuracy * 100).toFixed(1)}% - consider reviewing content difficulty.`
        });
    }
    
    if (analytics.active_students > 0) {
        insights.push({
            type: 'info',
            icon: 'fas fa-users',
            title: 'Active Engagement',
            description: `${analytics.active_students} students have completed sessions recently.`
        });
    }
    
    if (analytics.total_sessions > 10) {
        insights.push({
            type: 'success',
            icon: 'fas fa-graduation-cap',
            title: 'High Activity',
            description: `${analytics.total_sessions} total sessions completed across all students.`
        });
    }
    
    // Learning styles insights
    const learningStyles = analytics.learning_styles || {};
    const dominantStyle = Object.keys(learningStyles).reduce((a, b) => learningStyles[a] > learningStyles[b] ? a : b, 'visual');
    
    insights.push({
        type: 'info',
        icon: 'fas fa-brain',
        title: 'Learning Style Distribution',
        description: `Most students show ${dominantStyle} learning preferences.`
    });
    
    // Default insight if no real data
    if (insights.length === 0) {
        insights.push({
            type: 'info',
            icon: 'fas fa-info-circle',
            title: 'Getting Started',
            description: 'Complete your first session to see personalized insights and analytics.'
        });
    }
    
    let html = '';
    insights.forEach(insight => {
        const alertClass = `alert-${insight.type}`;
        html += `
            <div class="alert ${alertClass} mb-3">
                <div class="d-flex align-items-start">
                    <i class="${insight.icon} me-2 mt-1"></i>
                    <div>
                        <h6 class="mb-1">${insight.title}</h6>
                        <p class="mb-0 small">${insight.description}</p>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function setupFilters() {
    const filters = ['timePeriodFilter', 'subjectFilter', 'learningStyleFilter', 'gradeFilter'];
    
    filters.forEach(filterId => {
        const filter = document.getElementById(filterId);
        filter.addEventListener('change', function() {
            loadAnalytics();
        });
    });
}

function exportReport() {
    showLoading();
    
    // Get real analytics data for export
    Promise.all([
        fetch('/api/analytics').then(response => response.json()),
        fetch('/api/dashboard').then(response => response.json())
    ])
    .then(([analyticsData, dashboardData]) => {
        const analytics = analyticsData.analytics;
        const students = dashboardData.dashboard || [];
        
        // Create CSV content with real data
        let csvContent = 'Student,Learning Style,Recent Accuracy,Total Sessions,Avg Engagement\n';
        
        students.forEach(student => {
            csvContent += `${student.name},${student.learning_style},${(student.recent_accuracy * 100).toFixed(1)}%,${student.total_sessions},${(student.avg_engagement * 100).toFixed(1)}%\n`;
        });
        
        // Add analytics summary
        csvContent += '\nAnalytics Summary\n';
        csvContent += `Total Students,${analytics.total_students}\n`;
        csvContent += `Total Sessions,${analytics.total_sessions}\n`;
        csvContent += `Average Accuracy,${(analytics.avg_accuracy * 100).toFixed(1)}%\n`;
        csvContent += `Average Session Time,${Math.round(analytics.avg_session_time)} minutes\n`;
        csvContent += `Active Students,${analytics.active_students}\n`;
        
        // Create download link
        const link = document.createElement('a');
        link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
        link.download = `neurolearn_analytics_report_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        hideLoading();
        showSuccess('Report exported successfully');
    })
    .catch(error => {
        console.error('Error exporting report:', error);
        hideLoading();
        showError('Failed to export report');
    });
}

function showLoading() {
    document.getElementById('loadingSpinner').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const mainContent = document.querySelector('.main-content .container-fluid');
    mainContent.insertBefore(alert, mainContent.firstChild);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const mainContent = document.querySelector('.main-content .container-fluid');
    mainContent.insertBefore(alert, mainContent.firstChild);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %} 